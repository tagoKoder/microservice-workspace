<configuration scan="true">
     <!-- Hace visible application.properties:LOG_FILE_PATH dentro de Logback -->
  <springProperty scope="context" name="LOG_FILE_PATH" source="LOG_FILE_PATH"/>
  <include resource="org/springframework/boot/logging/logback/defaults.xml"/>

  <!-- Enriquecemos MDC con trace_id/span_id y baggage (ver interceptor abajo) -->
  <appender name="JSON_CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
    <encoder class="net.logstash.logback.encoder.LoggingEventCompositeJsonEncoder">
      <providers>
        <timestamp/>
        <pattern>
          <pattern>
            {
              "level": "%level",
              "logger": "%logger{36}",
              "thread": "%thread",
              "message": "%message",
              "service": "${SERVICE_NAME:-identity-service}",
              "env": "${ENVIRONMENT:-dev}",
              "trace_id": "%X{trace_id}",
              "span_id": "%X{span_id}",
              "user_id": "%X{user_id}",
              "agency_id": "%X{agency_id}",
              "exception": "%xThrowable"
            }
          </pattern>
        </pattern>
        <arguments/>
      </providers>
    </encoder>
  </appender>

  <appender name="JSON_FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
    <file>${LOG_FILE_PATH}</file>
    <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
      <fileNamePattern>${LOG_FILE_PATH}.%d{yyyy-MM-dd}.%i.gz</fileNamePattern>
      <maxFileSize>50MB</maxFileSize>
      <maxHistory>14</maxHistory>
      <totalSizeCap>5GB</totalSizeCap>
    </rollingPolicy>
    <encoder class="net.logstash.logback.encoder.LoggingEventCompositeJsonEncoder">
      <providers>
        <timestamp/>
        <pattern>
          <pattern>
            {
              "level": "%level",
              "logger": "%logger{36}",
              "thread": "%thread",
              "message": "%message",
              "service": "${SERVICE_NAME:-identity-service}",
              "env": "${ENVIRONMENT:-dev}",
              "trace_id": "%X{trace_id}",
              "span_id": "%X{span_id}",
              "user_id": "%X{user_id}",
              "agency_id": "%X{agency_id}",
              "exception": "%xThrowable"
            }
          </pattern>
        </pattern>
      </providers>
    </encoder>
  </appender>

  <!-- Sentry captura WARN+ para correlaciÃ³n con trace -->
  <appender name="SENTRY" class="io.sentry.logback.SentryAppender"/>

  <root level="${LOG_LEVEL:INFO}">
    <appender-ref ref="JSON_CONSOLE"/>
    <appender-ref ref="JSON_FILE"/>
    <appender-ref ref="SENTRY"/>
  </root>
</configuration>
