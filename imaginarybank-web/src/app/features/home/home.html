<div class="home p-4">
  <!-- (Opcional pero recomendado para ver toasts) -->
  <p-toast></p-toast>

  <!-- Top bar -->
  <div class="home__top flex align-items-center justify-content-between mb-4">
    <div class="flex flex-column gap-1">
      <div class="home__brand">ImaginaryBank</div>
      <div class="text-600 text-sm">
        Bienvenido,
        <span class="font-medium">{{ maskId((session$ | async)?.customer_id) }}</span>
      </div>
    </div>

    <div class="flex align-items-center gap-2">
      <p-tag
        [value]="(session$ | async)?.user_status || 'unknown'"
        [severity]="(session$ | async)?.user_status === 'active' ? 'success' : 'warn'">
      </p-tag>

      <button
        pButton
        type="button"
        class="p-button-outlined"
        icon="pi pi-sign-out"
        label="Cerrar sesión"
        (click)="logout()">
      </button>
    </div>
  </div>

  <div class="grid">
    <!-- Left: Accounts -->
    <div class="col-12 lg:col-7">
      <p-card header="Tus cuentas" styleClass="card-soft">
        <ng-container *ngIf="(accounts$ | async) as accRes; else loadingAcc">
          <ng-container *ngIf="(accRes.accounts || []).length > 0; else emptyAcc">

            <!-- Carousel -->
            <p-carousel
              [value]="(accountsCache.length ? accountsCache : accRes.accounts)"
              [numVisible]="1"
              [numScroll]="1"
              [circular]="true"
              [showIndicators]="false"
              [showNavigators]="false"
              (onPage)="onCarouselPage($event)"
              styleClass="accounts-carousel">
              <ng-template let-a pTemplate="item">
                <div class="account-hero">
                  <div class="flex justify-content-between align-items-start">
                    <div class="flex flex-column gap-1">
                      <div class="account-hero__title">{{ a.product_type }} · {{ a.currency }}</div>
                      <div class="text-600 text-sm">ID: {{ maskId(a.id) }}</div>
                      <div class="mt-2">
                        <p-tag [value]="a.status" [severity]="a.status === 'active' ? 'success' : 'warn'"></p-tag>
                      </div>
                    </div>

                    <div class="text-right">
                      <div class="text-600 text-sm">Disponible</div>
                      <div class="account-hero__money">
                        {{ formatMoney(a.balances?.available, a.currency) }}
                      </div>

                      <div class="mt-2 text-600 text-sm">Ledger / Hold</div>
                      <div class="text-sm">
                        {{ formatMoney(a.balances?.ledger, a.currency) }}
                        <span class="text-500">/</span>
                        {{ formatMoney(a.balances?.hold, a.currency) }}
                      </div>
                    </div>
                  </div>
                </div>
              </ng-template>
            </p-carousel>

            <!-- Controls -->
            <div class="flex align-items-center justify-content-between mt-3 gap-2 flex-wrap">
              <div class="flex align-items-center gap-2">
                <button
                  pButton
                  type="button"
                  icon="pi pi-angle-left"
                  class="p-button-text"
                  (click)="prevAccount()">
                </button>

                <div class="text-600 text-sm">Cuenta activa:</div>

                <!-- ✅ Reemplazo de p-dropdown por select nativo -->
                <select
                  class="bank-select"
                  [(ngModel)]="selectedAccountId"
                  (change)="onSelectAccountChange()">
                  <option
                    *ngFor="let a of (accountsCache.length ? accountsCache : accRes.accounts)"
                    [value]="a.id">
                    {{ a.product_type }} · {{ a.currency }} · {{ maskId(a.id) }}
                  </option>
                </select>

                <button
                  pButton
                  type="button"
                  icon="pi pi-angle-right"
                  class="p-button-text"
                  (click)="nextAccount()">
                </button>
              </div>

              <div class="flex align-items-center gap-2 flex-wrap">
                <button
                  pButton
                  type="button"
                  icon="pi pi-send"
                  label="Transferir"
                  (click)="openTransfer()">
                </button>

                <button
                  pButton
                  type="button"
                  class="p-button-outlined"
                  icon="pi pi-history"
                  label="Ver movimientos"
                  (click)="scrollToMovements()">
                </button>
              </div>
            </div>

            <!-- ✅ Reemplazo de accordion por bloque simple -->
            <div class="mt-3">
              <p-card header="Detalles de sesión (técnico)" styleClass="card-soft">
                <div class="grid">
                  <div class="col-12 md:col-6">
                    <div class="text-600 text-sm">OIDC Subject</div>
                    <div class="font-medium">{{ maskId((session$ | async)?.subject_id_oidc) }}</div>
                  </div>
                  <div class="col-12 md:col-6">
                    <div class="text-600 text-sm">Customer</div>
                    <div class="font-medium">{{ maskId((session$ | async)?.customer_id) }}</div>
                  </div>
                  <div class="col-12">
                    <div class="text-600 text-sm">Roles</div>
                    <div class="font-medium">{{ ((session$ | async)?.roles || []).join(', ') || '-' }}</div>
                  </div>
                </div>
              </p-card>
            </div>

          </ng-container>
        </ng-container>

        <ng-template #loadingAcc>
          <div class="grid">
            <div class="col-12">
              <p-skeleton height="10rem"></p-skeleton>
            </div>
            <div class="col-12">
              <p-skeleton height="2.5rem"></p-skeleton>
            </div>
          </div>
        </ng-template>

        <ng-template #emptyAcc>
          <div class="empty">
            <i class="pi pi-wallet empty__icon"></i>
            <div class="empty__title">Aún no tienes cuentas</div>
            <div class="empty__text">Cuando se creen tus productos, aquí verás tus saldos y acciones.</div>
          </div>
        </ng-template>
      </p-card>
    </div>

    <!-- Right: Movements -->
    <div class="col-12 lg:col-5" id="movements">
      <p-card header="Movimientos recientes" styleClass="card-soft">
        <ng-container *ngIf="recentTx.length > 0; else emptyTx">
          <p-table [value]="recentTx" [paginator]="false" responsiveLayout="scroll">
            <ng-template pTemplate="header">
              <tr>
                <th>Fecha</th>
                <th>Tipo</th>
                <th>Monto</th>
                <th>Estado</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-t>
              <tr>
                <td>{{ t.when | date:'short' }}</td>
                <td>{{ t.type }}</td>
                <td>{{ formatMoney(t.amount, t.currency) }}</td>
                <td>
                  <p-tag [value]="t.status" [severity]="t.status === 'posted' ? 'success' : 'warn'"></p-tag>
                </td>
              </tr>
            </ng-template>
          </p-table>
        </ng-container>

        <ng-template #emptyTx>
          <div class="empty">
            <i class="pi pi-calendar empty__icon"></i>
            <div class="empty__title">Sin movimientos</div>
            <div class="empty__text">
              Cuando realices transferencias o recibas abonos, aparecerán aquí.
            </div>
          </div>
        </ng-template>
      </p-card>

      <p-card header="Acciones esenciales" styleClass="card-soft mt-3">
        <div class="grid">
          <div class="col-12">
            <button
              pButton
              type="button"
              class="w-full"
              icon="pi pi-send"
              label="Nueva transferencia"
              (click)="openTransfer()">
            </button>
          </div>
          <div class="col-12">
            <button
              pButton
              type="button"
              class="p-button-outlined w-full"
              icon="pi pi-file"
              label="Estado de cuenta (próx.)"
              (click)="toastInfo('Próximamente', 'Estado de cuenta aún no está habilitado en el demo.')">
            </button>
          </div>
        </div>
      </p-card>
    </div>
  </div>

  <!-- Transfer dialog -->
  <p-dialog
    header="Transferencia"
    [(visible)]="transferOpen"
    [modal]="true"
    [draggable]="false"
    [resizable]="false"
    [style]="{ width: '560px' }"
    [breakpoints]="{ '960px': '95vw' }">

    <div class="grid" *ngIf="accountsCache.length">
      <div class="col-12">
        <div class="text-600 text-sm mb-1">Desde</div>

        <!-- ✅ select nativo -->
        <select class="bank-select w-full" [(ngModel)]="transferFromId">
          <option *ngFor="let a of accountsCache" [value]="a.id">
            {{ a.product_type }} · {{ a.currency }} · Disp: {{ formatMoney(a.balances.available, a.currency) }}
          </option>
        </select>
      </div>

      <div class="col-12">
        <div class="text-600 text-sm mb-1">Hacia</div>

        <!-- ✅ select nativo -->
        <select class="bank-select w-full" [(ngModel)]="transferToId">
          <option *ngFor="let a of accountsCache" [value]="a.id">
            {{ a.product_type }} · {{ a.currency }} · {{ maskId(a.id) }}
          </option>
        </select>

        <div class="text-500 text-xs mt-1">
          (Por ahora: transferencias entre tus propias cuentas)
        </div>
      </div>

      <div class="col-12 md:col-6">
        <div class="text-600 text-sm mb-1">Monto</div>
        <p-inputNumber
          [(ngModel)]="transferAmount"
          [min]="0.01"
          [maxFractionDigits]="2"
          inputStyleClass="w-full"
          styleClass="w-full">
        </p-inputNumber>
      </div>

      <div class="col-12 md:col-6">
        <div class="text-600 text-sm mb-1">Referencia</div>
        <input pInputText class="w-full" [(ngModel)]="transferMemo" placeholder="Opcional" />
      </div>

      <div class="col-12">
        <p-divider></p-divider>
        <div class="flex justify-content-end gap-2">
          <button pButton type="button" class="p-button-text" label="Cancelar" (click)="transferOpen=false"></button>
          <button
            pButton
            type="button"
            icon="pi pi-check"
            label="Enviar"
            [disabled]="!canSubmitTransfer()"
            (click)="submitTransfer()">
          </button>
        </div>

        <div class="text-500 text-xs mt-2">
          Seguridad: el frontend no maneja JWT; el BFF valida sesión/csrf y ejecuta la operación.
        </div>
      </div>
    </div>

    <div *ngIf="!accountsCache.length" class="empty">
      <i class="pi pi-wallet empty__icon"></i>
      <div class="empty__title">No hay cuentas</div>
      <div class="empty__text">Necesitas al menos una cuenta para transferir.</div>
    </div>
  </p-dialog>
</div>
