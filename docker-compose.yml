version: "3.9"

name: microservice-workspace

networks:
  banknet:
    driver: bridge

volumes:
  pgdata:
  localstack-data:

services:
  # ---------------------------
  # Postgres (local)
  # ---------------------------
  postgres:
    image: postgres:16-alpine
    container_name: bank-postgres
    environment:
      POSTGRES_USER: bank
      POSTGRES_PASSWORD: bank
      POSTGRES_DB: postgres
    ports:
      - "5442:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./infra/local/postgres/init:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U bank -d postgres"]
      interval: 5s
      timeout: 3s
      retries: 20
    networks: [banknet]

  # ---------------------------
  # LocalStack (EventBridge, SQS, SNS, S3)
  # ---------------------------
  localstack:
    image: localstack/localstack:3.5
    container_name: bank-localstack
    environment:
      # Servicios AWS emulados
      SERVICES: s3,sqs,sns,eventbridge,iam,sts,logs
      AWS_DEFAULT_REGION: ${AWS_REGION:-us-east-1}
      DEBUG: ${LOCALSTACK_DEBUG:-0}
      # Persistencia opcional
      PERSISTENCE: "1"
      # Vars usadas por el bootstrap
      EVENTBUS_NAME: ${EVENTBUS_NAME:-imaginarybank-audit}
      AUDIT_QUEUE_NAME: ${AUDIT_QUEUE_NAME:-imaginarybank-audit-queue}
      AUDIT_DLQ_NAME: ${AUDIT_DLQ_NAME:-imaginarybank-audit-dlq}
      NOTIFICATIONS_TOPIC: ${NOTIFICATIONS_TOPIC:-imaginarybank-notifications}
      KYC_BUCKET: ${KYC_BUCKET:-imaginarybank-kyc-local}
    ports:
      - "4566:4566"
    volumes:
      - localstack-data:/var/lib/localstack
      - /var/run/docker.sock:/var/run/docker.sock
      # scripts que se ejecutan cuando LocalStack est√° listo
      - ./infra/local/localstack/init:/etc/localstack/init/ready.d:ro
    networks: [banknet]


  # ---------------------------
  # Redis (local)
  # ---------------------------
  redis:
    image: redis:7-alpine
    container_name: bank-redis
    ports:
      - "6379:6379"
    networks: [banknet]


  # ---------------------------
  # Ledger DB Migrations (Flyway - one shot)
  # ---------------------------
  ledger-migrate:
    image: flyway/flyway:10-alpine
    container_name: bank-ledger-migrate
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      # <- tu ruta real de migraciones
      - ./micro/ledger/resources/migration:/flyway/sql:ro
    # OJO: usa JDBC URL, no postgresql://
    command:
      - -url=jdbc:postgresql://postgres:5432/ledger
      - -user=bank
      - -password=bank
      - -schemas=public
      - -connectRetries=30
      - migrate
    networks: [banknet]
    restart: "no"

  # ---------------------------
  # Identity (Spring Boot)
  # ---------------------------
  identity:
    build:
      context: ./micro/identity
      dockerfile: Dockerfile
    container_name: bank-identity
    env_file:
      - ./micro/identity/.env
    depends_on:
      postgres:
        condition: service_healthy
      localstack:
        condition: service_started
    ports:
      - "19091:9091"   # gRPC (si aplica)
    healthcheck:
      test: ["CMD-SHELL", "/usr/local/bin/grpc_health_probe -addr=localhost:9091 -connect-timeout=2s -rpc-timeout=2s"]
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 60s
    networks: [banknet]
    volumes:
      - ./.aws:/home/appuser/.aws:ro

  # ---------------------------
  # Account (Spring Boot)
  # ---------------------------
  account:
    build:
      context: ./micro/account
      dockerfile: Dockerfile
    container_name: bank-account
    env_file:
      - ./micro/account/.env
    depends_on:
      postgres:
        condition: service_healthy
      localstack:
        condition: service_started
    ports:
      - "19092:9092"

    healthcheck:
      test: ["CMD-SHELL", "/usr/local/bin/grpc_health_probe -addr=localhost:9092 -connect-timeout=2s -rpc-timeout=2s"]
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 60s

    networks: [banknet]

    volumes:
      - ./.aws:/home/appuser/.aws:ro

  # ---------------------------
  # Ledger (Go)
  # ---------------------------
  ledger:
    build:
      context: ./micro/ledger
      dockerfile: Dockerfile
    container_name: bank-ledger
    env_file:
      - ./micro/ledger/.env
    depends_on:
      postgres:
        condition: service_healthy
      localstack:
        condition: service_started
      account:
        condition: service_healthy
    ports:
      - "19093:9093"
    networks: [banknet]
    volumes:
      - ./.aws:/home/nonroot/.aws:ro

  # ---------------------------
  # BFF (Go)
  # ---------------------------
  # bff:
  #   build:
  #     context: ./bff
  #     dockerfile: Dockerfile
  #   container_name: bank-bff
  #   env_file:
  #     - ./bff/.env
  #   depends_on:
  #     postgres:
  #       condition: service_healthy
  #     identity:
  #       condition: service_healthy
  #     account:
  #       condition: service_healthy
  #     ledger:
  #       condition: service_started
  #     localstack:
  #       condition: service_started
  #   ports:
  #     - "8080:8080"
  #   networks: [banknet]
  #   volumes:
  #     - ./.aws:/home/appuser/.aws:ro
